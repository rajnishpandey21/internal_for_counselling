<!DOCTYPE html>
<html lang="en">
<head>

  <link rel="icon" href="my-favicon.png" type="image/png">
<link rel="apple-touch-icon" href="my-favicon.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CareerKaptain Internal - Dynamic Dashboard</title>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
        --gap: 15px;
    }

    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

html, body {
    height: 100vh;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #333;
    overflow: hidden;
    background-image:
    url('background.png');

    background-size: cover;
    background-position: center center;
    background-attachment: fixed;
}

    body.modal-open {
        overflow: hidden;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: var(--gap);
    }

    .dashboard-container {
        width: 100%;
        height: 100%;
        max-width: 1600px;
        display: flex;
        flex-direction: column;
        gap: var(--gap);
    }

    .card {
        background-color: #ffffff;
        border: 2px solid;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 15px;
        display: flex;
        flex-direction: column;
        position: relative;
        /* This is crucial for the loading overlay */
    }

    .row {
        display: flex;
        gap: var(--gap);
        width: 100%;
    }

    .row.fixed-row {
        flex: 0 0 auto;
        align-items: center;
    }

    .row.flexible-row {
        flex: 1;
        min-height: 0;
    }

    .row.flexible-row-large {
        flex: 1.5;
        min-height: 0;
    }

    .header-card {
        flex-direction: row;
        align-items: center;
        gap: 15px;
        padding: 10px 20px;
        flex: 1;
        /* A shorthand for grow and shrink */
        min-width: 0;
    }

    .header-card label {
        font-weight: 500;
    }

    .header-card input {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    .refresh-button {
        padding: 12px 22px;
        border: 2px solid black;
        border-radius: 16px;
        background-image: linear-gradient(to top right, #ffb75e, #ed8f03);
        color: black;
        font-weight: bold;
        font-size: 1em;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
    }

    .refresh-button:hover {
        transform: translateY(-2px);
    }

    .refresh-button:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }

    .export-master-btn {
        background-image: linear-gradient(to top right, #4a90e2, #0052a2);
        /* A distinct blue gradient */
        color: white;
    }
    
    .export-daywise-btn {
        background-image: linear-gradient(to top right, #6d3f9c, #4a2b6e);
        /* A deep purple gradient */
        color: white;
    }

    .header-button-group {
        display: flex;
        gap: var(--gap);
        flex-shrink: 0;
        /* This prevents the buttons from shrinking */
    }

    .stat-card {
        flex: 1;
        text-align: center;
        justify-content: center;
        padding: 5px 10px;
        /* ADD a minimum width to prevent cards from becoming too narrow */
        min-width: 140px;
    }

    .stat-card h3 {
        margin: 0 0 5px 0;
        font-size: 0.8em;
        color: #555;
        font-weight: 600;
    }

    .stat-card .number {
        margin: 0;
        font-size: 2em;
        font-weight: bold;
        color: #000;
    }

    .stat-card.clickable {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card.clickable:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    .chart-card {
        flex-grow: 1;
        min-width: 0;
        justify-content: flex-start;
    }

    .chart-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        text-align: center;
        flex-shrink: 0;
    }

    .chart-container {
        position: relative;
        flex-grow: 1;
        width: 100%;
        height: 350px;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: thin;
        scrollbar-color: #888 #eee;
    }
    
    .chart-container::-webkit-scrollbar {
        width: 8px;
    }

    .chart-container::-webkit-scrollbar-thumb {
        background-color: #999;
        border-radius: 4px;
    }

    .row .chart-col-4 {
        flex: 1;
    }

    .expand-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        background-color: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        z-index: 5;
        /* Ensure it's above the chart but below the loader */
    }

    .expand-btn:hover {
        background-color: rgba(0, 0, 0, 0.15);
    }

    .expand-btn svg {
        width: 16px;
        height: 16px;
        stroke: #333;
        stroke-width: 2;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal.open {
        display: flex;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 16px;
        width: 90vw;
        height: 85vh;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2.5em;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        color: #555;
        transition: color 0.2s ease;
        z-index: 10;
    }

    .modal-close-btn:hover {
        color: #000;
    }

    .modal-chart-container {
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #modalCanvas {
        width: 100% !important;
        display: block;
    }

    select.college-dropdown {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        appearance: none;
        background-color: #fff;
        flex: 1;
        /* Makes the dropdown flexible to grow and shrink */
        min-width: 95px;
        /* Use a smaller, more reasonable minimum width */
    }

    /* --- START: Loading Spinner Styles --- */
    .card .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        /* White, slightly transparent */
        border-radius: 16px;
        /* Match the card's border-radius */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        opacity: 0;
        /* Hidden by default */
        pointer-events: none;
        /* Cannot be clicked */
        transition: opacity 0.3s ease;
    }

    .card .loading-overlay.visible {
        opacity: 1;
        /* Make it visible */
        pointer-events: auto;
        /* Can block clicks on the card while loading */
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #ed8f03;
        /* Use your theme's orange color */
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    .dashboard-container > .row.fixed-row:nth-of-type(2) {
        flex-wrap: nowrap; /* Force all cards onto one line and prevent wrapping */
        gap: 5px;         /* Slightly reduce the gap between cards */
    }

    /* Now, make the stat cards themselves more compact */
    .dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card {
        padding: 8px 6px;   /* Reduce horizontal padding */
        min-width: 0;       /* Allow cards to shrink to a very small size if needed */
        flex-grow: 1;       /* Allow cards to grow to fill space */
        flex-basis: 0;      /* Distribute space evenly before growing */
    }

    /* Reduce the font size of the card titles and reserve space for two lines */
    .dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card h3 {
        font-size: 0.7em; /* Make title text smaller */
        line-height: 1;
        /* Give space for 2 lines of text to prevent cards from jumping in height */
        min-height: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Drastically reduce the font size of the large number */
    .dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card .number {
        font-size: 1.7em; /* Make the main number smaller */
    }

    @media (max-width: 1200px) {
        :root {
            --gap: 10px;
        }

        .stat-card .number {
            font-size: 1.5em;
        }

        .stat-card h3 {
            font-size: 0.75em;
        }
    }

    @media (max-width: 992px) {

        html,
        body {
            height: auto;
            overflow: auto;
        }

        .row {
            flex-wrap: wrap;
        }

        .header-card {
            flex-wrap: wrap;
            justify-content: center;
        }
    }

    /* --- START: KPI Icon Styles --- */

/* Create a flex container for the card title and icon */
.stat-card .card-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px; /* Space between title and icon */
}

/* Remove the old margin from the h3 tag to keep alignment perfect */
.stat-card h3 {
    margin-bottom: 0; 
}

/* Style the icon's wrapper span */
.kpi-icon {
    display: inline-flex;
    align-items: center;
    cursor: help; /* Show a help cursor on hover */
    margin-top: -2px; /* Fine-tune vertical alignment */
}

/* Style the SVG icon itself */
.kpi-icon svg {
    width: 14px;
    height: 14px;
    fill: #666; /* A neutral, non-distracting color */
    opacity: 0.8;
}

/* --- START: Payout Checkbox Style --- */
.payout-option {
    margin-top: 0px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0px;
    font-size: 0.7em;
    color: #333;
}
.payout-option label {
    cursor: pointer;
}
.stat-card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center; 
}

.dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card {
    padding-top: 5px;
    padding-bottom: 5px;
}

.dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card .number {
    font-size: 1.8em; 
    margin-bottom: 5px; 
}

.payout-option {
    margin-top: 2px;
    flex-shrink: 0;
}

#payout-card {
    padding-bottom: 10px; 
}
#payout-card .payout-option {
    position: absolute;
    bottom: 2px;
    left: 0;     
    width: 100%;
    margin-top: 0;
}

/* ADD THIS NEW RULE */
.payout-option input[type="checkbox"] {
    margin: 0;
    padding: 0;
    margin-right: 3px; /* Optional: Add a tiny, controlled space back if they touch too closely */
}

 #payout-card .number {
    font-size: 1.5em; 
}
</style>
</head>

<body>
  <div class="dashboard-container">
    <div class="row fixed-row">
      <div class="card header-card">
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date" />
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date" />

        <label for="college-select">College:</label>
        <select id="college-select" class="college-dropdown">
          <option value="__ALL__">All Colleges</option>
        </select>
      </div>
       <div class="header-button-group">
      <button id="export-master-btn" class="refresh-button export-master-btn">Export Master Report</button>
      <button id="export-daywise-btn" class="refresh-button export-daywise-btn">Export Day-wise Push</button>
      <button id="refresh-data-btn" class="refresh-button">Refresh Data</button>
      </div>
    </div>

   <div class="row fixed-row">

    <div id="total-push-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Total Push To ERP Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="total-push" class="number">...</p>
        </div>
    </div>

    <div id="unique-push-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Unique Push To ERP Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="unique-push" class="number">...</p>
        </div>
    </div>

    <div id="total-apps-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Total Applications Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="total-apps" class="number">-</p>
        </div>
    </div>

    <div id="primary-apps-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Primary Apps Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="primary-apps" class="number">-</p>
        </div>
    </div>

    <div id="total-admissions-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Total Admissions Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="total-admissions" class="number">-</p>
        </div>
    </div>

    <div id="primary-admissions-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Primary Admissions Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="primary-admissions" class="number">-</p>
        </div>
    </div>


</div>
   <div class="row flexible-row">
  <div id="leadsPushedChartCard" class="card chart-card chart-col-4">
    <button class="expand-btn" data-chart-id="leadsPushedChart">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Leads Pushed by University</h3>
    <div class="chart-container">
      <canvas id="leadsPushedChart"></canvas>
    </div>
  </div>
  <div id="primaryAppsChartCard" class="card chart-card chart-col-4">
    <button class="expand-btn" data-chart-id="primaryAppsChart">
       <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Primary Applications</h3>
    <div class="chart-container">
       <canvas id="primaryAppsChart"></canvas>
    </div>
  </div>
  <div id="primaryAdmissionsChartCard" class="card chart-card chart-col-4">
     <button class="expand-btn" data-chart-id="primaryAdmissionsChart">
       <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Primary Admissions</h3>
    <div class="chart-container">
       <canvas id="primaryAdmissionsChart"></canvas>
    </div>
  </div>
  <div id="leadCompositionChartCard" class="card chart-card chart-col-4">
    <h3>Lead Composition</h3>
    <div class="chart-container">
      <canvas id="leadCompositionChart"></canvas>
    </div>
  </div>
</div>
<div class="row flexible-row-large">
  <div id="pushTrendChartCard" class="card chart-card">
    <button class="expand-btn" data-chart-id="pushTrendChart">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Push to ERP and Unique Trend</h3>
    <div class="chart-container">
      <canvas id="pushTrendChart"></canvas>
    </div>
  </div>
</div>
  </div>

  <div id="chartModal" class="modal">
    <div class="modal-content">
      <button class="modal-close-btn" aria-label="Close modal">&times;</button>
      <div id="modalChartContainer" class="modal-chart-container">
        </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
const DashboardApp = {
    webAppUrl: 'https://script.google.com/macros/s/AKfycbyPlyZ9w1F-AmwJFd0YnmpIFq01qbia_BasejEPb5xU8_bI4URxd8MPhMf7Q1CoqO1Q/exec',

    // Raw data from the backend
masterData: {
    push: [],
    totalApplications: [],
    primaryApplications: [],
    totalAdmissions: [],
    primaryAdmissions: [],

    // Make sure the old 'totalPayout' line is REMOVED
},

    // Data that matches the date/college filters
    filteredData: {
        push: [],
        totalApplications: [],
        primaryApplications: [],
        totalAdmissions: [],
        primaryAdmissions: [],

    },

    // To store all chart instances
    charts: {},
    modalChart: null,

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.setupEventListeners();
            this.loadDashboardData();
        });
    },

    setupEventListeners() {
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const refreshButton = document.getElementById('refresh-data-btn');
        const collegeSelect = document.getElementById('college-select');
        const exportMasterButton = document.getElementById('export-master-btn');
        const exportDayWiseButton = document.getElementById('export-daywise-btn');

        startDateInput.addEventListener('change', () => this.updateDashboardView());
        endDateInput.addEventListener('change', () => this.updateDashboardView());
        collegeSelect.addEventListener('change', () => this.updateDashboardView());
        refreshButton.addEventListener('click', () => this.loadDashboardData());
        exportMasterButton.addEventListener('click', () => this.exportMasterReport());
        exportDayWiseButton.addEventListener('click', () => this.exportDayWisePushReport());

        
        const modal = document.getElementById('chartModal');
        const closeBtn = modal.querySelector('.modal-close-btn');
        if (closeBtn) closeBtn.addEventListener('click', () => this.closeChartModal());
        modal.addEventListener('click', e => {
            if (e.target === modal) this.closeChartModal();
        });

        document.querySelector('.dashboard-container').addEventListener('click', (e) => {
            const expandBtn = e.target.closest('.expand-btn');
            if (expandBtn) {
                const chartId = expandBtn.dataset.chartId;
                const chartInstance = this.charts[chartId];
                if (chartInstance) {
                    this.openChartModal(chartInstance);
                } else {
                    alert('Chart is not available to expand.');
                }
            }
        });
        
        this.setupClickableKpis(); 
    },

    // =========================================================================
    // DATA FETCHING & HANDLING
    // =========================================================================
    async loadDashboardData() {
        const refreshButton = document.getElementById('refresh-data-btn');
        try {
            if (refreshButton) {
                refreshButton.textContent = '🔄 Refreshing...';
                refreshButton.disabled = true;
            }
            document.querySelectorAll('.card[id]').forEach(card => this.showLoader(card.id));

            const response = await fetch(this.webAppUrl);
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);

            const data = await response.json();
            if (data.error) throw new Error(`Script error: ${JSON.stringify(data.error)}`);

            this.masterData.push = data.push_data || [];
            this.masterData.totalApplications = data.total_applications || [];
            this.masterData.primaryApplications = data.primary_applications || [];
            this.masterData.totalAdmissions = data.total_admissions || [];
            this.masterData.primaryAdmissions = data.primary_admissions || [];


            if (this.masterData.push.length === 0 && this.masterData.totalApplications.length === 0) {
                throw new Error('All data sources returned empty.');
            }

            this.populateCollegeDropdown();
            this.updateDashboardView();

        } catch (error) {
            console.error('Dashboard loading error:', error);
            document.getElementById('total-push').innerText = 'Error';
            document.getElementById('unique-push').innerText = 'Error';
            document.querySelectorAll('.card[id]').forEach(card => this.hideLoader(card.id));
        } finally {
            if (refreshButton) {
                refreshButton.textContent = 'Refresh Data';
                refreshButton.disabled = false;
            }
        }
    },
    
    updateDashboardView() {
        const startDate = document.getElementById('start-date').value;
        let endDate = document.getElementById('end-date').value;
        const selectedCollege = document.getElementById('college-select').value;
        
        if (startDate && !endDate) {
            endDate = new Date().toISOString().split('T')[0];
        }

        const dateFilter = (row, dateColumn) => (!startDate || row[dateColumn] >= startDate) && (!endDate || row[dateColumn] <= endDate);
        const collegeFilter = (row, collegeColumn) => (selectedCollege === '__ALL__') || (row[collegeColumn] === selectedCollege);

        this.filteredData.push = this.masterData.push.filter(row => dateFilter(row, 'Captured On') && collegeFilter(row, 'Opportunity: University Interested In'));
        this.filteredData.totalApplications = this.masterData.totalApplications.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
        this.filteredData.primaryApplications = this.masterData.primaryApplications.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
        this.filteredData.totalAdmissions = this.masterData.totalAdmissions.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
        this.filteredData.primaryAdmissions = this.masterData.primaryAdmissions.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
        
        this.renderAll();
    },



    renderAll() {
        this.renderKPIs();
        
        this.renderUniversityChart(this.filteredData.push, 'leadsPushedChart', 'Opportunity: University Interested In');
        this.renderUniversityChart(this.filteredData.primaryApplications, 'primaryAppsChart', 'college');
        this.renderUniversityChart(this.filteredData.primaryAdmissions, 'primaryAdmissionsChart', 'college');
        this.renderLeadCompositionChart(this.filteredData.push);
        this.renderPushTrendChart(this.filteredData.push);

    },

renderKPIs() {
    // Standard KPIs filtered by date
    document.getElementById('total-push').innerText = this.filteredData.push.length;
    document.getElementById('unique-push').innerText = this.getUniqueLeadCount(this.filteredData.push);
    document.getElementById('total-apps').innerText = this.filteredData.totalApplications.length;
    document.getElementById('primary-apps').innerText = this.filteredData.primaryApplications.length;
    document.getElementById('total-admissions').innerText = this.filteredData.totalAdmissions.length;
    document.getElementById('primary-admissions').innerText = this.filteredData.primaryAdmissions.length;

    // Hide all loaders
    ['total-push-card', 'unique-push-card', 'total-apps-card', 'primary-apps-card', 
     'total-admissions-card', 'primary-admissions-card'].forEach(id => this.hideLoader(id));
},
    renderUniversityChart(data, canvasId, collegeColumnName) {
        const card = document.getElementById(canvasId)?.closest('.card');
        if (!card) return;
        const cardId = card.id;

        setTimeout(() => {
            const counts = data.reduce((acc, row) => {
                const univ = row[collegeColumnName];
                if (univ) acc[univ] = (acc[univ] || 0) + 1;
                return acc;
            }, {});

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(([k]) => k);
            const values = sorted.map(([, v]) => v);

            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const container = canvas.parentElement;
            const ctx = canvas.getContext('2d');
            
            if (this.charts[canvasId] instanceof Chart) {
                this.charts[canvasId].destroy();
            }
            
            const containerWidth = container.clientWidth;
            const barHeight = 30;
            const newCanvasHeight = Math.max(300, labels.length * barHeight); 
            
            canvas.width = containerWidth;
            canvas.height = newCanvasHeight;
            canvas.style.width = `${containerWidth}px`;
            canvas.style.height = `${newCanvasHeight}px`;

            this.charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data: values, backgroundColor: 'rgba(237, 143, 3, 0.7)', borderColor: 'rgba(237, 143, 3, 1)', borderWidth: 1, barThickness: 20 }] },
                options: {
                    indexAxis: 'y',
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    layout: { padding: { left: 10, right: 20, top: 10, bottom: 10 } },
                    scales: { x: { beginAtZero: true, ticks: { precision: 0 } }, y: { ticks: { autoSkip: false } } }
                }
            });
            
            this.hideLoader(cardId);
        }, 100);
    },

    renderLeadCompositionChart(data) {
        const cardId = 'leadCompositionChartCard';
        this.hideLoader(cardId);
        const unique = this.getUniqueLeadCount(data);
        const duplicates = data.length - unique;

        const canvas = document.getElementById('leadCompositionChart');
        if (!canvas) return;
        
        if (this.charts.leadCompositionChart instanceof Chart) this.charts.leadCompositionChart.destroy();

        this.charts.leadCompositionChart = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: { labels: ['Unique Leads', 'Duplicate Leads'], datasets: [{ data: [unique, duplicates], backgroundColor: ['#ed8f03', '#ffb75e'], hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
    },

    // =====================================================================
    // DELETED THE REDUNDANT RENDERPUSHTRENDCHART FUNCTION FROM HERE
    // =====================================================================

    renderPushTrendChart(data) {
        const cardId = 'pushTrendChartCard';
        const grouped = {};
        data.forEach(row => {
            const date = row['Captured On'];
            if (!date) return;
            const mobile = (row['Mobile Number'] || '').replace(/\D/g, '');
            if (!grouped[date]) grouped[date] = { total: 0, uniqueSet: new Set() };
            grouped[date].total++;
            if (mobile) grouped[date].uniqueSet.add(mobile);
        });

        const dates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));
        const total = dates.map(d => grouped[d].total);
        const unique = dates.map(d => grouped[d].uniqueSet.size);

        const canvas = document.getElementById('pushTrendChart');
        if (!canvas) return;

        if (this.charts.pushTrendChart instanceof Chart) this.charts.pushTrendChart.destroy();

        this.charts.pushTrendChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { labels: dates, datasets: [{ label: 'Total Pushes', data: total, borderColor: '#ed8f03', backgroundColor: 'rgba(237,143,3,0.1)', fill: true, tension: 0.3 }, { label: 'Unique Pushes', data: unique, borderColor: '#6a3d9a', backgroundColor: 'rgba(106, 61, 154, 0.1)', fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy' } } }, plugins: { legend: { position: 'top' } } }
        });
        this.hideLoader(cardId);
    },

    // UI INTERACTION & HELPERS
    // =========================================================================
    showLoader(elementId) {
        const overlay = document.querySelector(`#${elementId} .loading-overlay`);
        if (overlay) overlay.classList.add('visible');
    },

    hideLoader(elementId) {
        const overlay = document.querySelector(`#${elementId} .loading-overlay`);
        if (overlay) overlay.classList.remove('visible');
    },

    populateCollegeDropdown() {
        const collegeSelect = document.getElementById('college-select');
        if (!collegeSelect) return;
        const pushColleges = new Set(this.masterData.push.map(row => row['Opportunity: University Interested In']));
        const appColleges = new Set(this.masterData.totalApplications.map(row => row.college));
        const admissionColleges = new Set(this.masterData.totalAdmissions.map(row => row.college));
        const allColleges = [...new Set([...pushColleges, ...appColleges, ...admissionColleges])];
        const sortedColleges = allColleges.filter(Boolean).sort();
        collegeSelect.innerHTML = '<option value="__ALL__">All Colleges</option>';
        sortedColleges.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            collegeSelect.appendChild(opt);
        });
    },

    getUniqueLeadCount(data) {
        const uniqueMobiles = new Set();
        data.forEach(row => {
            const mobile = (row['Mobile Number'] || '').toString().replace(/\D/g, '');
            if (mobile) uniqueMobiles.add(mobile);
        });
        return uniqueMobiles.size;
    },

    setupClickableKpis() {
const kpiConfig = {
    'total-push-card':         { title: 'Total Pushed Leads',       dataType: 'push_total',             page: 'leads_details.html' },
    'unique-push-card':        { title: 'Unique Pushed Leads',      dataType: 'push_unique',            page: 'leads_details.html' },
    'total-apps-card':         { title: 'Total Applications',       dataType: 'total_applications',     page: 'details_page.html' },
    'primary-apps-card':       { title: 'Primary Applications',     dataType: 'primary_applications',   page: 'details_page.html' },
    'total-admissions-card':   { title: 'Total Admissions',         dataType: 'total_admissions',       page: 'details_page.html' },
    'primary-admissions-card': { title: 'Primary Admissions',       dataType: 'primary_admissions',     page: 'details_page.html' }
};

        for (const cardId in kpiConfig) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.add('clickable');
                card.addEventListener('click', () => this.openDetailsPage(kpiConfig[cardId]));
            }
        }
    },
    
// REPLACE your entire openDetailsPage function with this one
openDetailsPage(config) {
    let dataToShow = [];
    const getUniqueItems = (data, key) => {
        const uniqueKeys = new Set();
        return data.filter(row => {
            const value = (row[key] || '').toString().replace(/\D/g, '');
            if (value && !uniqueKeys.has(value)) {
                uniqueKeys.add(value);
                return true;
            }
            return false;
        });
    };

    // This switch statement decides what data to show
    switch (config.dataType) {
        // --- Existing cases (no change) ---
        case 'push_total':
            dataToShow = this.filteredData.push;
            break;
        case 'push_unique':
            dataToShow = getUniqueItems(this.filteredData.push, 'Mobile Number');
            break;
        case 'total_applications':
            dataToShow = this.filteredData.totalApplications;
            break;
        case 'primary_applications':
            dataToShow = this.filteredData.primaryApplications;
            break;
        case 'total_admissions':
            dataToShow = this.filteredData.totalAdmissions;
            break;
        case 'primary_admissions':
            dataToShow = this.filteredData.primaryAdmissions;
            break;


    }

    if (dataToShow && dataToShow.length > 0) {
        const headers = Object.keys(dataToShow[0]);
        const normalizedData = dataToShow.map(row => {
            let newRow = {};
            headers.forEach(header => newRow[header] = row[header] || '');
            return newRow;
        });

        sessionStorage.setItem('detailsData', JSON.stringify(normalizedData));
        sessionStorage.setItem('detailsTitle', config.title);
        
        window.open(config.page, '_blank');
    } else {
        alert('No data to show for this selection.');
    }
},

    openChartModal(originalChart) {
        const modal = document.getElementById('chartModal');
        const container = document.getElementById('modalChartContainer');
        if (!modal || !container) return;

        container.innerHTML = '';
        modal.classList.add('open');
        document.body.classList.add('modal-open');

        const canvas = document.createElement('canvas');
        container.appendChild(canvas);

        if (this.modalChart) {
            this.modalChart.destroy();
        }

        const newOptions = JSON.parse(JSON.stringify(originalChart.config.options));
        
        if (originalChart.config.type === 'bar' && newOptions.indexAxis === 'y') {
            const containerWidth = container.clientWidth;
            const barHeight = 35;
            const verticalPadding = 50;
            const newCanvasHeight = (originalChart.data.labels.length * barHeight) + verticalPadding;

            canvas.width = containerWidth;
            canvas.height = newCanvasHeight;

            newOptions.responsive = false;
            newOptions.maintainAspectRatio = false;

            if (newOptions.plugins && newOptions.plugins.legend) {
                newOptions.plugins.legend.display = false;
            }

        } 
        else {
            newOptions.responsive = true;
            newOptions.maintainAspectRatio = false;

            if (newOptions.plugins && newOptions.plugins.legend) {
                newOptions.plugins.legend.display = true;
            }
        }
        
        this.modalChart = new Chart(canvas.getContext('2d'), {
            type: originalChart.config.type,
            data: JSON.parse(JSON.stringify(originalChart.data)),
            options: newOptions
        });
    },

    closeChartModal() {
        const modal = document.getElementById('chartModal');
        if (!modal) return;
        
        if (this.modalChart) {
            this.modalChart.destroy();
            this.modalChart = null;
        }
        modal.classList.remove('open');
        document.body.classList.remove('modal-open');
    },

    exportMasterReport() {
        console.log("Master report export started...");

        const pushColleges = new Set(this.filteredData.push.map(row => row['Opportunity: University Interested In']));
        const appColleges = new Set(this.filteredData.totalApplications.map(row => row.college));
        const admissionColleges = new Set(this.filteredData.totalAdmissions.map(row => row.college));
        const allColleges = [...new Set([...pushColleges, ...appColleges, ...admissionColleges])].filter(Boolean).sort();

        if (allColleges.length === 0) {
            alert("No data available to export for the selected filters.");
            return;
        }

        const reportData = [];
        for (const collegeName of allColleges) {
            const leadsForCollege = this.filteredData.push.filter(row => row['Opportunity: University Interested In'] === collegeName);
            const totalAppsForCollege = this.filteredData.totalApplications.filter(row => row.college === collegeName);
            const primaryAppsForCollege = this.filteredData.primaryApplications.filter(row => row.college === collegeName);
            const totalAdmissionsForCollege = this.filteredData.totalAdmissions.filter(row => row.college === collegeName);
            const primaryAdmissionsForCollege = this.filteredData.primaryAdmissions.filter(row => row.college === collegeName);

            reportData.push({
                'College Name': collegeName,
                'Total Leads Pushed': leadsForCollege.length,
                'Unique Leads Pushed': this.getUniqueLeadCount(leadsForCollege),
                'Total Applications': totalAppsForCollege.length,
                'Primary Applications': primaryAppsForCollege.length,
                'Total Admissions': totalAdmissionsForCollege.length,
                'Primary Admissions': primaryAdmissionsForCollege.length,
            });
        }

        const headers = Object.keys(reportData[0]);
        const csvRows = [headers.join(',')];

        for (const row of reportData) {
            const values = headers.map(header => {
                const value = row[header];
                const escaped = ('' + value).replace(/"/g, '""');
                return `"${escaped}"`;
            });
            csvRows.push(values.join(','));
        }

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const today = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `master_report_${today}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    },

    exportDayWisePushReport() {
        console.log("Pivoted day-wise push report export started...");

        const pushData = this.filteredData.push;

        if (pushData.length === 0) {
            alert("No push data available to export for the selected filters.");
            return;
        }

        const colleges = new Set();
        const dates = new Set();
        pushData.forEach(row => {
            if (row['Opportunity: University Interested In']) {
                colleges.add(row['Opportunity: University Interested In']);
            }
            if (row['Captured On']) {
                dates.add(row['Captured On']);
            }
        });

        const sortedColleges = [...colleges].sort();
        const sortedDates = [...dates].sort((a, b) => new Date(a) - new Date(b));

        if (sortedColleges.length === 0 || sortedDates.length === 0) {
            alert("Data is missing college names or dates, cannot generate report.");
            return;
        }

        const pivotData = {};
        for (const row of pushData) {
            const collegeName = row['Opportunity: University Interested In'];
            const date = row['Captured On'];

            if (!collegeName || !date) continue;

            if (!pivotData[collegeName]) {
                pivotData[collegeName] = {};
            }
            if (!pivotData[collegeName][date]) {
                pivotData[collegeName][date] = 0;
            }

            pivotData[collegeName][date]++;
        }

        const reportData = [];
        for (const collegeName of sortedColleges) {
            const rowObject = { 'College Name': collegeName };
            for (const date of sortedDates) {
                const count = pivotData[collegeName]?.[date] || 0;
                rowObject[date] = count;
            }
            reportData.push(rowObject);
        }

        const headers = Object.keys(reportData[0]);
        const csvRows = [headers.join(',')];

        for (const row of reportData) {
            const values = headers.map(header => {
                const value = row[header];
                const escaped = ('' + value).replace(/"/g, '""');
                return `"${escaped}"`;
            });
            csvRows.push(values.join(','));
        }

        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const today = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `day_wise_pivot_report_${today}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    },
};

// Initialize the application
DashboardApp.init();

</script>
</body>
</html>
