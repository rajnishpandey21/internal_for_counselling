<!DOCTYPE html>
<html lang="en">
<head>

  <link rel="icon" href="my-favicon.png" type="image/png">
<link rel="apple-touch-icon" href="my-favicon.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CareerKaptain Internal - Dynamic Dashboard</title>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
        --gap: 15px;
    }

    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

html, body {
    height: 100vh;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #333;
    overflow: hidden;
    background-image:
    url('background.png');

    background-size: cover;
    background-position: center center;
    background-attachment: fixed;
}

    body.modal-open {
        overflow: hidden;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: var(--gap);
    }

    .dashboard-container {
        width: 100%;
        height: 100%;
        max-width: 1600px;
        display: flex;
        flex-direction: column;
        gap: var(--gap);
    }

    .card {
        background-color: #ffffff;
        border: 2px solid;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 15px;
        display: flex;
        flex-direction: column;
        position: relative;
        /* This is crucial for the loading overlay */
    }

    .row {
        display: flex;
        gap: var(--gap);
        width: 100%;
    }

    .row.fixed-row {
        flex: 0 0 auto;
        align-items: center;
    }

    .row.flexible-row {
        flex: 1;
        min-height: 0;
    }

    .row.flexible-row-large {
        flex: 1.5;
        min-height: 0;
    }

    .header-card {
        flex-direction: row;
        align-items: center;
        gap: 15px;
        padding: 10px 20px;
        flex: 1;
        /* A shorthand for grow and shrink */
        min-width: 0;
    }

    .header-card label {
        font-weight: 500;
    }

    .header-card input {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    .refresh-button {
        padding: 12px 22px;
        border: 2px solid black;
        border-radius: 16px;
        background-image: linear-gradient(to top right, #ffb75e, #ed8f03);
        color: black;
        font-weight: bold;
        font-size: 1em;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
    }

    .refresh-button:hover {
        transform: translateY(-2px);
    }

    .refresh-button:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }

    .export-master-btn {
        background-image: linear-gradient(to top right, #4a90e2, #0052a2);
        /* A distinct blue gradient */
        color: white;
    }
    
    .export-daywise-btn {
        background-image: linear-gradient(to top right, #6d3f9c, #4a2b6e);
        /* A deep purple gradient */
        color: white;
    }

    .header-button-group {
        display: flex;
        gap: var(--gap);
        flex-shrink: 0;
        /* This prevents the buttons from shrinking */
    }

    .stat-card {
        flex: 1;
        text-align: center;
        justify-content: center;
        padding: 5px 10px;
        /* ADD a minimum width to prevent cards from becoming too narrow */
        min-width: 140px;
    }

    .stat-card h3 {
        margin: 0 0 5px 0;
        font-size: 0.8em;
        color: #555;
        font-weight: 600;
    }

    .stat-card .number {
        margin: 0;
        font-size: 2em;
        font-weight: bold;
        color: #000;
    }

    .stat-card.clickable {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card.clickable:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    .chart-card {
        flex-grow: 1;
        min-width: 0;
        justify-content: flex-start;
    }

    .chart-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        text-align: center;
        flex-shrink: 0;
    }

    .chart-container {
        position: relative;
        flex-grow: 1;
        width: 100%;
        height: 350px;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: thin;
        scrollbar-color: #888 #eee;
    }
    
    .chart-container::-webkit-scrollbar {
        width: 8px;
    }

    .chart-container::-webkit-scrollbar-thumb {
        background-color: #999;
        border-radius: 4px;
    }

    .row .chart-col-4 {
        flex: 1;
    }

    .expand-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        background-color: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        z-index: 5;
        /* Ensure it's above the chart but below the loader */
    }

    .expand-btn:hover {
        background-color: rgba(0, 0, 0, 0.15);
    }

    .expand-btn svg {
        width: 16px;
        height: 16px;
        stroke: #333;
        stroke-width: 2;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal.open {
        display: flex;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 16px;
        width: 90vw;
        height: 85vh;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2.5em;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        color: #555;
        transition: color 0.2s ease;
        z-index: 10;
    }

    .modal-close-btn:hover {
        color: #000;
    }

    .modal-chart-container {
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    #modalCanvas {
        width: 100% !important;
        display: block;
    }

    select.college-dropdown {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        appearance: none;
        background-color: #fff;
        flex: 1;
        /* Makes the dropdown flexible to grow and shrink */
        min-width: 95px;
        /* Use a smaller, more reasonable minimum width */
    }

    /* --- START: Loading Spinner Styles --- */
    .card .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        /* White, slightly transparent */
        border-radius: 16px;
        /* Match the card's border-radius */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        opacity: 0;
        /* Hidden by default */
        pointer-events: none;
        /* Cannot be clicked */
        transition: opacity 0.3s ease;
    }

    .card .loading-overlay.visible {
        opacity: 1;
        /* Make it visible */
        pointer-events: auto;
        /* Can block clicks on the card while loading */
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #ed8f03;
        /* Use your theme's orange color */
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    .dashboard-container > .row.fixed-row:nth-of-type(2) {
        flex-wrap: nowrap; /* Force all cards onto one line and prevent wrapping */
        gap: 5px;         /* Slightly reduce the gap between cards */
    }

    /* Now, make the stat cards themselves more compact */
    .dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card {
        padding: 8px 6px;   /* Reduce horizontal padding */
        min-width: 0;       /* Allow cards to shrink to a very small size if needed */
        flex-grow: 1;       /* Allow cards to grow to fill space */
        flex-basis: 0;      /* Distribute space evenly before growing */
    }

    /* Reduce the font size of the card titles and reserve space for two lines */
    .dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card h3 {
        font-size: 0.7em; /* Make title text smaller */
        line-height: 1;
        /* Give space for 2 lines of text to prevent cards from jumping in height */
        min-height: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Drastically reduce the font size of the large number */
    .dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card .number {
        font-size: 1.7em; /* Make the main number smaller */
    }

    @media (max-width: 1200px) {
        :root {
            --gap: 10px;
        }

        .stat-card .number {
            font-size: 1.5em;
        }

        .stat-card h3 {
            font-size: 0.75em;
        }
    }

    @media (max-width: 992px) {

        html,
        body {
            height: auto;
            overflow: auto;
        }

        .row {
            flex-wrap: wrap;
        }

        .header-card {
            flex-wrap: wrap;
            justify-content: center;
        }
    }

    /* --- START: KPI Icon Styles --- */

/* Create a flex container for the card title and icon */
.stat-card .card-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px; /* Space between title and icon */
}

/* Remove the old margin from the h3 tag to keep alignment perfect */
.stat-card h3 {
    margin-bottom: 0; 
}

/* Style the icon's wrapper span */
.kpi-icon {
    display: inline-flex;
    align-items: center;
    cursor: help; /* Show a help cursor on hover */
    margin-top: -2px; /* Fine-tune vertical alignment */
}

/* Style the SVG icon itself */
.kpi-icon svg {
    width: 14px;
    height: 14px;
    fill: #666; /* A neutral, non-distracting color */
    opacity: 0.8;
}

/* --- START: Payout Checkbox Style --- */
.payout-option {
    margin-top: 0px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0px;
    font-size: 0.7em;
    color: #333;
}
.payout-option label {
    cursor: pointer;
}
.stat-card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center; 
}

.dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card {
    padding-top: 5px;
    padding-bottom: 5px;
}

.dashboard-container > .row.fixed-row:nth-of-type(2) .stat-card .number {
    font-size: 1.8em; 
    margin-bottom: 5px; 
}

.payout-option {
    margin-top: 2px;
    flex-shrink: 0;
}

#payout-card {
    padding-bottom: 10px; 
}
#payout-card .payout-option {
    position: absolute;
    bottom: 2px;
    left: 0;     
    width: 100%;
    margin-top: 0;
}

/* ADD THIS NEW RULE */
.payout-option input[type="checkbox"] {
    margin: 0;
    padding: 0;
    margin-right: 3px; /* Optional: Add a tiny, controlled space back if they touch too closely */
}

 #payout-card .number {
    font-size: 1.5em; 
}
</style>
</head>

<body>
  <div class="dashboard-container">
    <div class="row fixed-row">
      <div class="card header-card">
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date" />
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date" />

        <label for="college-select">College:</label>
        <select id="college-select" class="college-dropdown">
          <option value="__ALL__">All Colleges</option>
        </select>
      </div>
       <div class="header-button-group">
      <button id="export-master-btn" class="refresh-button export-master-btn">Export Master Report</button>
      <button id="export-daywise-btn" class="refresh-button export-daywise-btn">Export Day-wise Push</button>
      <button id="refresh-data-btn" class="refresh-button">Refresh Data</button>
      </div>
    </div>

   <div class="row fixed-row">

    <div id="total-push-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Total Push To ERP Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="total-push" class="number">...</p>
        </div>
    </div>

    <div id="unique-push-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Unique Push To ERP Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="unique-push" class="number">...</p>
        </div>
    </div>

    <div id="total-apps-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Total Applications Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="total-apps" class="number">-</p>
        </div>
    </div>

    <div id="primary-apps-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Primary Apps Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="primary-apps" class="number">-</p>
        </div>
    </div>

    <div id="total-admissions-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Total Admissions Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="total-admissions" class="number">-</p>
        </div>
    </div>

    <div id="primary-admissions-card" class="card stat-card">
        <div class="loading-overlay"><div class="spinner"></div></div>
        <div class="stat-card-body">
            <div class="card-header">
                <h3>Primary Admissions Count</h3>
                <span class="kpi-icon" title="This metric is filtered by the selected date range."><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></span>
            </div>
            <p id="primary-admissions" class="number">-</p>
        </div>
    </div>


</div>
   <div class="row flexible-row">
  <div id="leadsPushedChartCard" class="card chart-card chart-col-4">
    <button class="expand-btn" data-chart-id="leadsPushedChart">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Leads Pushed by University</h3>
    <div class="chart-container">
      <canvas id="leadsPushedChart"></canvas>
    </div>
  </div>
  <div id="primaryAppsChartCard" class="card chart-card chart-col-4">
    <button class="expand-btn" data-chart-id="primaryAppsChart">
       <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Primary Applications</h3>
    <div class="chart-container">
       <canvas id="primaryAppsChart"></canvas>
    </div>
  </div>
  <div id="primaryAdmissionsChartCard" class="card chart-card chart-col-4">
     <button class="expand-btn" data-chart-id="primaryAdmissionsChart">
       <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Primary Admissions</h3>
    <div class="chart-container">
       <canvas id="primaryAdmissionsChart"></canvas>
    </div>
  </div>
  <div id="leadCompositionChartCard" class="card chart-card chart-col-4">
    <h3>Lead Composition</h3>
    <div class="chart-container">
      <canvas id="leadCompositionChart"></canvas>
    </div>
  </div>
</div>
<div class="row flexible-row-large">
  <div id="pushTrendChartCard" class="card chart-card">
    <button class="expand-btn" data-chart-id="pushTrendChart">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h3>Push to ERP and Unique Trend</h3>
    <div class="chart-container">
      <canvas id="pushTrendChart"></canvas>
    </div>
  </div>
</div>
  </div>

  <div id="chartModal" class="modal">
    <div class="modal-content">
      <button class="modal-close-btn" aria-label="Close modal">&times;</button>
      <div id="modalChartContainer" class="modal-chart-container">
        </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
const DashboardApp = {
Â  Â  webAppUrl: 'https://script.google.com/macros/s/AKfycbyPlyZ9w1F-AmwJFd0YnmpIFq01qbia_BasejEPb5xU8_bI4URxd8MPhMf7Q1CoqO1Q/exec',

Â  Â  // Raw data from the backend
masterData: {
    push: [],
    totalApplications: [],
    primaryApplications: [],
    totalAdmissions: [],
    primaryAdmissions: [],

    // Make sure the old 'totalPayout' line is REMOVED
},

Â  Â  // Data that matches the date/college filters
Â  Â  filteredData: {
Â  Â  Â  Â  push: [],
Â  Â  Â  Â  totalApplications: [],
Â  Â  Â  Â  primaryApplications: [],
Â  Â  Â  Â  totalAdmissions: [],
Â  Â  Â  Â  primaryAdmissions: [],

Â  Â  },

Â  Â  // To store all chart instances
Â  Â  charts: {},
Â  Â  modalChart: null,

Â  Â  // =========================================================================
Â  Â  // INITIALIZATION
Â  Â  // =========================================================================
Â  Â  init() {
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  this.setupEventListeners();
Â  Â  Â  Â  Â  Â  this.loadDashboardData();
Â  Â  Â  Â  });
Â  Â  },

    setupEventListeners() {
    Â  Â  const startDateInput = document.getElementById('start-date');
    Â  Â  const endDateInput = document.getElementById('end-date');
    Â  Â  const refreshButton = document.getElementById('refresh-data-btn');
    Â  Â  const collegeSelect = document.getElementById('college-select');
    Â  Â  const exportMasterButton = document.getElementById('export-master-btn');
    Â  Â  const exportDayWiseButton = document.getElementById('export-daywise-btn');

    Â  Â  startDateInput.addEventListener('change', () => this.updateDashboardView());
    Â  Â  endDateInput.addEventListener('change', () => this.updateDashboardView());
    Â  Â  collegeSelect.addEventListener('change', () => this.updateDashboardView());
    Â  Â  refreshButton.addEventListener('click', () => this.loadDashboardData());
    Â  Â  exportMasterButton.addEventListener('click', () => this.exportMasterReport());
    Â  Â  exportDayWiseButton.addEventListener('click', () => this.exportDayWisePushReport());

    Â  Â  
    Â  Â  const modal = document.getElementById('chartModal');
    Â  Â  const closeBtn = modal.querySelector('.modal-close-btn');
    Â  Â  if (closeBtn) closeBtn.addEventListener('click', () => this.closeChartModal());
    Â  Â  modal.addEventListener('click', e => {
    Â  Â  Â  Â  if (e.target === modal) this.closeChartModal();
    Â  Â  });

    Â  Â  document.querySelector('.dashboard-container').addEventListener('click', (e) => {
    Â  Â  Â  Â  const expandBtn = e.target.closest('.expand-btn');
    Â  Â  Â  Â  if (expandBtn) {
    Â  Â  Â  Â  Â  Â  const chartId = expandBtn.dataset.chartId;
    Â  Â  Â  Â  Â  Â  const chartInstance = this.charts[chartId];
    Â  Â  Â  Â  Â  Â  if (chartInstance) {
    Â  Â  Â  Â  Â  Â  Â  Â  this.openChartModal(chartInstance);
    Â  Â  Â  Â  Â  Â  } else {
    Â  Â  Â  Â  Â  Â  Â  Â  alert('Chart is not available to expand.');
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  }
    Â  Â  });
    Â  Â  
    Â  Â  this.setupClickableKpis(); 
    },

Â  Â  // =========================================================================
Â  Â  // DATA FETCHING & HANDLING
Â  Â  // =========================================================================
Â  Â  async loadDashboardData() {
Â  Â  Â  Â  const refreshButton = document.getElementById('refresh-data-btn');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (refreshButton) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshButton.textContent = 'ðŸ”„ Refreshing...';
Â  Â  Â  Â  Â  Â  Â  Â  refreshButton.disabled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.card[id]').forEach(card => this.showLoader(card.id));

Â  Â  Â  Â  Â  Â  const response = await fetch(this.webAppUrl);
Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`Network error: ${response.statusText}`);

Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data.error) throw new Error(`Script error: ${JSON.stringify(data.error)}`);

Â  Â  Â  Â  Â  Â  this.masterData.push = data.push_data || [];
Â  Â  Â  Â  Â  Â  this.masterData.totalApplications = data.total_applications || [];
Â  Â  Â  Â  Â  Â  this.masterData.primaryApplications = data.primary_applications || [];
Â  Â  Â  Â  Â  Â  this.masterData.totalAdmissions = data.total_admissions || [];
Â  Â  Â  Â  Â  Â  this.masterData.primaryAdmissions = data.primary_admissions || [];


Â  Â  Â  Â  Â  Â  if (this.masterData.push.length === 0 && this.masterData.totalApplications.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('All data sources returned empty.');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  this.populateCollegeDropdown();
Â  Â  Â  Â  Â  Â  this.updateDashboardView();

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Dashboard loading error:', error);
Â  Â  Â  Â  Â  Â  document.getElementById('total-push').innerText = 'Error';
Â  Â  Â  Â  Â  Â  document.getElementById('unique-push').innerText = 'Error';
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.card[id]').forEach(card => this.hideLoader(card.id));
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  if (refreshButton) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshButton.textContent = 'Refresh Data';
Â  Â  Â  Â  Â  Â  Â  Â  refreshButton.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  },
Â  Â  
Â  Â  updateDashboardView() {
Â  Â  Â  Â  const startDate = document.getElementById('start-date').value;
Â  Â  Â  Â  let endDate = document.getElementById('end-date').value;
Â  Â  Â  Â  const selectedCollege = document.getElementById('college-select').value;
Â  Â  Â  Â  
Â  Â  Â  Â  if (startDate && !endDate) {
Â  Â  Â  Â  Â  Â  endDate = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  }

Â  Â  Â  Â  const dateFilter = (row, dateColumn) => (!startDate || row[dateColumn] >= startDate) && (!endDate || row[dateColumn] <= endDate);
Â  Â  Â  Â  const collegeFilter = (row, collegeColumn) => (selectedCollege === '__ALL__') || (row[collegeColumn] === selectedCollege);

Â  Â  Â  Â  this.filteredData.push = this.masterData.push.filter(row => dateFilter(row, 'Captured On') && collegeFilter(row, 'Opportunity: University Interested In'));
Â  Â  Â  Â  this.filteredData.totalApplications = this.masterData.totalApplications.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
Â  Â  Â  Â  this.filteredData.primaryApplications = this.masterData.primaryApplications.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
Â  Â  Â  Â  this.filteredData.totalAdmissions = this.masterData.totalAdmissions.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
Â  Â  Â  Â  this.filteredData.primaryAdmissions = this.masterData.primaryAdmissions.filter(row => dateFilter(row, 'Date') && collegeFilter(row, 'college'));
Â  Â  Â  Â  
Â  Â  Â  Â  this.renderAll();
Â  Â  },



Â  Â  renderAll() {
Â  Â  Â  Â  this.renderKPIs();
Â  Â  Â  Â  
Â  Â  Â  Â  this.renderUniversityChart(this.filteredData.push, 'leadsPushedChart', 'Opportunity: University Interested In');
Â  Â  Â  Â  this.renderUniversityChart(this.filteredData.primaryApplications, 'primaryAppsChart', 'college');
Â  Â  Â  Â  this.renderUniversityChart(this.filteredData.primaryAdmissions, 'primaryAdmissionsChart', 'college');
Â  Â  Â  Â  this.renderLeadCompositionChart(this.filteredData.push);
Â  Â  Â  Â  this.renderPushTrendChart(this.filteredData.push);

Â  Â  },

renderKPIs() {
    // Standard KPIs filtered by date
    document.getElementById('total-push').innerText = this.filteredData.push.length;
    document.getElementById('unique-push').innerText = this.getUniqueLeadCount(this.filteredData.push);
    document.getElementById('total-apps').innerText = this.filteredData.totalApplications.length;
    document.getElementById('primary-apps').innerText = this.filteredData.primaryApplications.length;
    document.getElementById('total-admissions').innerText = this.filteredData.totalAdmissions.length;
    document.getElementById('primary-admissions').innerText = this.filteredData.primaryAdmissions.length;

    // Hide all loaders
    ['total-push-card', 'unique-push-card', 'total-apps-card', 'primary-apps-card', 
     'total-admissions-card', 'primary-admissions-card'].forEach(id => this.hideLoader(id));
},
Â  Â  renderUniversityChart(data, canvasId, collegeColumnName) {
Â  Â  Â  Â  const card = document.getElementById(canvasId)?.closest('.card');
Â  Â  Â  Â  if (!card) return;
Â  Â  Â  Â  const cardId = card.id;

Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  const counts = data.reduce((acc, row) => {
Â  Â  Â  Â  Â  Â  Â  Â  const univ = row[collegeColumnName];
Â  Â  Â  Â  Â  Â  Â  Â  if (univ) acc[univ] = (acc[univ] || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  Â  Â  }, {});

Â  Â  Â  Â  Â  Â  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
Â  Â  Â  Â  Â  Â  const labels = sorted.map(([k]) => k);
Â  Â  Â  Â  Â  Â  const values = sorted.map(([, v]) => v);

Â  Â  Â  Â  Â  Â  const canvas = document.getElementById(canvasId);
Â  Â  Â  Â  Â  Â  if (!canvas) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const container = canvas.parentElement;
Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (this.charts[canvasId] instanceof Chart) {
Â  Â  Â  Â  Â  Â  Â  Â  this.charts[canvasId].destroy();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const containerWidth = container.clientWidth;
Â  Â  Â  Â  Â  Â  const barHeight = 30;
Â  Â  Â  Â  Â  Â  const newCanvasHeight = Math.max(300, labels.length * barHeight); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  canvas.width = containerWidth;
Â  Â  Â  Â  Â  Â  canvas.height = newCanvasHeight;
Â  Â  Â  Â  Â  Â  canvas.style.width = `${containerWidth}px`;
Â  Â  Â  Â  Â  Â  canvas.style.height = `${newCanvasHeight}px`;

Â  Â  Â  Â  Â  Â  this.charts[canvasId] = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  Â  Â  data: { labels, datasets: [{ data: values, backgroundColor: 'rgba(237, 143, 3, 0.7)', borderColor: 'rgba(237, 143, 3, 1)', borderWidth: 1, barThickness: 20 }] },
Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indexAxis: 'y',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: { legend: { display: false } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layout: { padding: { left: 10, right: 20, top: 10, bottom: 10 } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scales: { x: { beginAtZero: true, ticks: { precision: 0 } }, y: { ticks: { autoSkip: false } } }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  this.hideLoader(cardId);
Â  Â  Â  Â  }, 100);
Â  Â  },

Â  Â  renderLeadCompositionChart(data) {
Â  Â  Â  Â  const cardId = 'leadCompositionChartCard';
Â  Â  Â  Â  this.hideLoader(cardId);
Â  Â  Â  Â  const unique = this.getUniqueLeadCount(data);
Â  Â  Â  Â  const duplicates = data.length - unique;

Â  Â  Â  Â  const canvas = document.getElementById('leadCompositionChart');
Â  Â  Â  Â  if (!canvas) return;
Â  Â  Â  Â  
Â  Â  Â  Â  if (this.charts.leadCompositionChart instanceof Chart) this.charts.leadCompositionChart.destroy();

Â  Â  Â  Â  this.charts.leadCompositionChart = new Chart(canvas.getContext('2d'), {
Â  Â  Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  Â  Â  data: { labels: ['Unique Leads', 'Duplicate Leads'], datasets: [{ data: [unique, duplicates], backgroundColor: ['#ed8f03', '#ffb75e'], hoverOffset: 4 }] },
Â  Â  Â  Â  Â  Â  options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
Â  Â  Â  Â  });
Â  Â  },

    // =====================================================================
    // DELETED THE REDUNDANT RENDERPUSHTRENDCHART FUNCTION FROM HERE
    // =====================================================================

Â  Â  renderPushTrendChart(data) {
Â  Â  Â  Â  const cardId = 'pushTrendChartCard';
Â  Â  Â  Â  const grouped = {};
Â  Â  Â  Â  data.forEach(row => {
Â  Â  Â  Â  Â  Â  const date = row['Captured On'];
Â  Â  Â  Â  Â  Â  if (!date) return;
Â  Â  Â  Â  Â  Â  const mobile = (row['Mobile Number'] || '').replace(/\D/g, '');
Â  Â  Â  Â  Â  Â  if (!grouped[date]) grouped[date] = { total: 0, uniqueSet: new Set() };
Â  Â  Â  Â  Â  Â  grouped[date].total++;
Â  Â  Â  Â  Â  Â  if (mobile) grouped[date].uniqueSet.add(mobile);
Â  Â  Â  Â  });

Â  Â  Â  Â  const dates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));
Â  Â  Â  Â  const total = dates.map(d => grouped[d].total);
Â  Â  Â  Â  const unique = dates.map(d => grouped[d].uniqueSet.size);

Â  Â  Â  Â  const canvas = document.getElementById('pushTrendChart');
Â  Â  Â  Â  if (!canvas) return;

Â  Â  Â  Â  if (this.charts.pushTrendChart instanceof Chart) this.charts.pushTrendChart.destroy();

Â  Â  Â  Â  this.charts.pushTrendChart = new Chart(canvas.getContext('2d'), {
Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  data: { labels: dates, datasets: [{ label: 'Total Pushes', data: total, borderColor: '#ed8f03', backgroundColor: 'rgba(237,143,3,0.1)', fill: true, tension: 0.3 }, { label: 'Unique Pushes', data: unique, borderColor: '#6a3d9a', backgroundColor: 'rgba(106, 61, 154, 0.1)', fill: true, tension: 0.3 }] },
Â  Â  Â  Â  Â  Â  options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy' } } }, plugins: { legend: { position: 'top' } } }
Â  Â  Â  Â  });
Â  Â  Â  Â  this.hideLoader(cardId);
Â  Â  },

Â  Â  // UI INTERACTION & HELPERS
Â  Â  // =========================================================================
Â  Â  showLoader(elementId) {
Â  Â  Â  Â  const overlay = document.querySelector(`#${elementId} .loading-overlay`);
Â  Â  Â  Â  if (overlay) overlay.classList.add('visible');
Â  Â  },

Â  Â  hideLoader(elementId) {
Â  Â  Â  Â  const overlay = document.querySelector(`#${elementId} .loading-overlay`);
Â  Â  Â  Â  if (overlay) overlay.classList.remove('visible');
Â  Â  },

Â  Â  populateCollegeDropdown() {
Â  Â  Â  Â  const collegeSelect = document.getElementById('college-select');
Â  Â  Â  Â  if (!collegeSelect) return;
Â  Â  Â  Â  const pushColleges = new Set(this.masterData.push.map(row => row['Opportunity: University Interested In']));
Â  Â  Â  Â  const appColleges = new Set(this.masterData.totalApplications.map(row => row.college));
Â  Â  Â  Â  const admissionColleges = new Set(this.masterData.totalAdmissions.map(row => row.college));
Â  Â  Â  Â  const allColleges = [...new Set([...pushColleges, ...appColleges, ...admissionColleges])];
Â  Â  Â  Â  const sortedColleges = allColleges.filter(Boolean).sort();
Â  Â  Â  Â  collegeSelect.innerHTML = '<option value="__ALL__">All Colleges</option>';
Â  Â  Â  Â  sortedColleges.forEach(name => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  opt.value = name;
Â  Â  Â  Â  Â  Â  opt.textContent = name;
Â  Â  Â  Â  Â  Â  collegeSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  },

Â  Â  getUniqueLeadCount(data) {
Â  Â  Â  Â  const uniqueMobiles = new Set();
Â  Â  Â  Â  data.forEach(row => {
Â  Â  Â  Â  Â  Â  const mobile = (row['Mobile Number'] || '').toString().replace(/\D/g, '');
Â  Â  Â  Â  Â  Â  if (mobile) uniqueMobiles.add(mobile);
Â  Â  Â  Â  });
Â  Â  Â  Â  return uniqueMobiles.size;
Â  Â  },

Â  Â  setupClickableKpis() {
const kpiConfig = {
    'total-push-card':         { title: 'Total Pushed Leads',       dataType: 'push_total',             page: 'leads_details.html' },
    'unique-push-card':        { title: 'Unique Pushed Leads',      dataType: 'push_unique',            page: 'leads_details.html' },
    'total-apps-card':         { title: 'Total Applications',       dataType: 'total_applications',     page: 'details_page.html' },
    'primary-apps-card':       { title: 'Primary Applications',     dataType: 'primary_applications',   page: 'details_page.html' },
    'total-admissions-card':   { title: 'Total Admissions',         dataType: 'total_admissions',       page: 'details_page.html' },
    'primary-admissions-card': { title: 'Primary Admissions',       dataType: 'primary_admissions',     page: 'details_page.html' }
};

    Â  Â  for (const cardId in kpiConfig) {
    Â  Â  Â  Â  const card = document.getElementById(cardId);
    Â  Â  Â  Â  if (card) {
    Â  Â  Â  Â  Â  Â  card.classList.add('clickable');
    Â  Â  Â  Â  Â  Â  card.addEventListener('click', () => this.openDetailsPage(kpiConfig[cardId]));
    Â  Â  Â  Â  }
    Â  Â  }
    },
Â  Â  
// REPLACE your entire openDetailsPage function with this one
openDetailsPage(config) {
    let dataToShow = [];
    const getUniqueItems = (data, key) => {
        const uniqueKeys = new Set();
        return data.filter(row => {
            const value = (row[key] || '').toString().replace(/\D/g, '');
            if (value && !uniqueKeys.has(value)) {
                uniqueKeys.add(value);
                return true;
            }
            return false;
        });
    };

    // This switch statement decides what data to show
    switch (config.dataType) {
        // --- Existing cases (no change) ---
        case 'push_total':
            dataToShow = this.filteredData.push;
            break;
        case 'push_unique':
            dataToShow = getUniqueItems(this.filteredData.push, 'Mobile Number');
            break;
        case 'total_applications':
            dataToShow = this.filteredData.totalApplications;
            break;
        case 'primary_applications':
            dataToShow = this.filteredData.primaryApplications;
            break;
        case 'total_admissions':
            dataToShow = this.filteredData.totalAdmissions;
            break;
        case 'primary_admissions':
            dataToShow = this.filteredData.primaryAdmissions;
            break;


    }

    if (dataToShow && dataToShow.length > 0) {
        const headers = Object.keys(dataToShow[0]);
        const normalizedData = dataToShow.map(row => {
            let newRow = {};
            headers.forEach(header => newRow[header] = row[header] || '');
            return newRow;
        });

        sessionStorage.setItem('detailsData', JSON.stringify(normalizedData));
        sessionStorage.setItem('detailsTitle', config.title);
        
        window.open(config.page, '_blank');
    } else {
        alert('No data to show for this selection.');
    }
},

Â  Â  openChartModal(originalChart) {
    Â  Â  const modal = document.getElementById('chartModal');
    Â  Â  const container = document.getElementById('modalChartContainer');
    Â  Â  if (!modal || !container) return;

    Â  Â  container.innerHTML = '';
    Â  Â  modal.classList.add('open');
    Â  Â  document.body.classList.add('modal-open');

    Â  Â  const canvas = document.createElement('canvas');
    Â  Â  container.appendChild(canvas);

    Â  Â  if (this.modalChart) {
    Â  Â  Â  Â  this.modalChart.destroy();
    Â  Â  }

    Â  Â  const newOptions = JSON.parse(JSON.stringify(originalChart.config.options));
    Â  Â  
    Â  Â  if (originalChart.config.type === 'bar' && newOptions.indexAxis === 'y') {
    Â  Â  Â  Â  const containerWidth = container.clientWidth;
    Â  Â  Â  Â  const barHeight = 35;
    Â  Â  Â  Â  const verticalPadding = 50;
    Â  Â  Â  Â  const newCanvasHeight = (originalChart.data.labels.length * barHeight) + verticalPadding;

    Â  Â  Â  Â  canvas.width = containerWidth;
    Â  Â  Â  Â  canvas.height = newCanvasHeight;

    Â  Â  Â  Â  newOptions.responsive = false;
    Â  Â  Â  Â  newOptions.maintainAspectRatio = false;

    Â  Â  Â  Â  if (newOptions.plugins && newOptions.plugins.legend) {
    Â  Â  Â  Â  Â  Â  newOptions.plugins.legend.display = false;
    Â  Â  Â  Â  }

    Â  Â  } 
    Â  Â  else {
    Â  Â  Â  Â  newOptions.responsive = true;
    Â  Â  Â  Â  newOptions.maintainAspectRatio = false;

    Â  Â  Â  Â  if (newOptions.plugins && newOptions.plugins.legend) {
    Â  Â  Â  Â  Â  Â  newOptions.plugins.legend.display = true;
    Â  Â  Â  Â  }
    Â  Â  }
    Â  Â  
    Â  Â  this.modalChart = new Chart(canvas.getContext('2d'), {
    Â  Â  Â  Â  type: originalChart.config.type,
    Â  Â  Â  Â  data: JSON.parse(JSON.stringify(originalChart.data)),
    Â  Â  Â  Â  options: newOptions
    Â  Â  });
    },

Â  Â  closeChartModal() {
Â  Â  Â  Â  const modal = document.getElementById('chartModal');
Â  Â  Â  Â  if (!modal) return;
Â  Â  Â  Â  
Â  Â  Â  Â  if (this.modalChart) {
Â  Â  Â  Â  Â  Â  this.modalChart.destroy();
Â  Â  Â  Â  Â  Â  this.modalChart = null;
Â  Â  Â  Â  }
Â  Â  Â  Â  modal.classList.remove('open');
Â  Â  Â  Â  document.body.classList.remove('modal-open');
Â  Â  },

    exportMasterReport() {
    Â  Â  console.log("Master report export started...");

    Â  Â  const pushColleges = new Set(this.filteredData.push.map(row => row['Opportunity: University Interested In']));
    Â  Â  const appColleges = new Set(this.filteredData.totalApplications.map(row => row.college));
    Â  Â  const admissionColleges = new Set(this.filteredData.totalAdmissions.map(row => row.college));
    Â  Â  const allColleges = [...new Set([...pushColleges, ...appColleges, ...admissionColleges])].filter(Boolean).sort();

    Â  Â  if (allColleges.length === 0) {
    Â  Â  Â  Â  alert("No data available to export for the selected filters.");
    Â  Â  Â  Â  return;
    Â  Â  }

    Â  Â  const reportData = [];
    Â  Â  for (const collegeName of allColleges) {
    Â  Â  Â  Â  const leadsForCollege = this.filteredData.push.filter(row => row['Opportunity: University Interested In'] === collegeName);
    Â  Â  Â  Â  const totalAppsForCollege = this.filteredData.totalApplications.filter(row => row.college === collegeName);
    Â  Â  Â  Â  const primaryAppsForCollege = this.filteredData.primaryApplications.filter(row => row.college === collegeName);
    Â  Â  Â  Â  const totalAdmissionsForCollege = this.filteredData.totalAdmissions.filter(row => row.college === collegeName);
    Â  Â  Â  Â  const primaryAdmissionsForCollege = this.filteredData.primaryAdmissions.filter(row => row.college === collegeName);

    Â  Â  Â  Â  reportData.push({
    Â  Â  Â  Â  Â  Â  'College Name': collegeName,
    Â  Â  Â  Â  Â  Â  'Total Leads Pushed': leadsForCollege.length,
    Â  Â  Â  Â  Â  Â  'Unique Leads Pushed': this.getUniqueLeadCount(leadsForCollege),
    Â  Â  Â  Â  Â  Â  'Total Applications': totalAppsForCollege.length,
    Â  Â  Â  Â  Â  Â  'Primary Applications': primaryAppsForCollege.length,
    Â  Â  Â  Â  Â  Â  'Total Admissions': totalAdmissionsForCollege.length,
    Â  Â  Â  Â  Â  Â  'Primary Admissions': primaryAdmissionsForCollege.length,
    Â  Â  Â  Â  });
    Â  Â  }

    Â  Â  const headers = Object.keys(reportData[0]);
    Â  Â  const csvRows = [headers.join(',')];

    Â  Â  for (const row of reportData) {
    Â  Â  Â  Â  const values = headers.map(header => {
    Â  Â  Â  Â  Â  Â  const value = row[header];
    Â  Â  Â  Â  Â  Â  const escaped = ('' + value).replace(/"/g, '""');
    Â  Â  Â  Â  Â  Â  return `"${escaped}"`;
    Â  Â  Â  Â  });
    Â  Â  Â  Â  csvRows.push(values.join(','));
    Â  Â  }

    Â  Â  const csvString = csvRows.join('\n');
    Â  Â  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    Â  Â  const url = URL.createObjectURL(blob);
    Â  Â  const a = document.createElement('a');
    Â  Â  
    Â  Â  const today = new Date().toISOString().slice(0, 10);
    Â  Â  a.href = url;
    Â  Â  a.download = `master_report_${today}.csv`;
    Â  Â  a.click();
    Â  Â  URL.revokeObjectURL(url);
    },

    exportDayWisePushReport() {
    Â  Â  console.log("Pivoted day-wise push report export started...");

    Â  Â  const pushData = this.filteredData.push;

    Â  Â  if (pushData.length === 0) {
    Â  Â  Â  Â  alert("No push data available to export for the selected filters.");
    Â  Â  Â  Â  return;
    Â  Â  }

    Â  Â  const colleges = new Set();
    Â  Â  const dates = new Set();
    Â  Â  pushData.forEach(row => {
    Â  Â  Â  Â  if (row['Opportunity: University Interested In']) {
    Â  Â  Â  Â  Â  Â  colleges.add(row['Opportunity: University Interested In']);
    Â  Â  Â  Â  }
    Â  Â  Â  Â  if (row['Captured On']) {
    Â  Â  Â  Â  Â  Â  dates.add(row['Captured On']);
    Â  Â  Â  Â  }
    Â  Â  });

    Â  Â  const sortedColleges = [...colleges].sort();
    Â  Â  const sortedDates = [...dates].sort((a, b) => new Date(a) - new Date(b));

    Â  Â  if (sortedColleges.length === 0 || sortedDates.length === 0) {
    Â  Â  Â  Â  alert("Data is missing college names or dates, cannot generate report.");
    Â  Â  Â  Â  return;
    Â  Â  }

    Â  Â  const pivotData = {};
    Â  Â  for (const row of pushData) {
    Â  Â  Â  Â  const collegeName = row['Opportunity: University Interested In'];
    Â  Â  Â  Â  const date = row['Captured On'];

    Â  Â  Â  Â  if (!collegeName || !date) continue;

    Â  Â  Â  Â  if (!pivotData[collegeName]) {
    Â  Â  Â  Â  Â  Â  pivotData[collegeName] = {};
    Â  Â  Â  Â  }
    Â  Â  Â  Â  if (!pivotData[collegeName][date]) {
    Â  Â  Â  Â  Â  Â  pivotData[collegeName][date] = 0;
    Â  Â  Â  Â  }

    Â  Â  Â  Â  pivotData[collegeName][date]++;
    Â  Â  }

    Â  Â  const reportData = [];
    Â  Â  for (const collegeName of sortedColleges) {
    Â  Â  Â  Â  const rowObject = { 'College Name': collegeName };
    Â  Â  Â  Â  for (const date of sortedDates) {
    Â  Â  Â  Â  Â  Â  const count = pivotData[collegeName]?.[date] || 0;
    Â  Â  Â  Â  Â  Â  rowObject[date] = count;
    Â  Â  Â  Â  }
    Â  Â  Â  Â  reportData.push(rowObject);
    Â  Â  }

    Â  Â  const headers = Object.keys(reportData[0]);
    Â  Â  const csvRows = [headers.join(',')];

    Â  Â  for (const row of reportData) {
    Â  Â  Â  Â  const values = headers.map(header => {
    Â  Â  Â  Â  Â  Â  const value = row[header];
    Â  Â  Â  Â  Â  Â  const escaped = ('' + value).replace(/"/g, '""');
    Â  Â  Â  Â  Â  Â  return `"${escaped}"`;
    Â  Â  Â  Â  });
    Â  Â  Â  Â  csvRows.push(values.join(','));
    Â  Â  }

    Â  Â  const csvString = csvRows.join('\n');
    Â  Â  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    Â  Â  const url = URL.createObjectURL(blob);
    Â  Â  const a = document.createElement('a');
    Â  Â  
    Â  Â  const today = new Date().toISOString().slice(0, 10);
    Â  Â  a.href = url;
    Â  Â  a.download = `day_wise_pivot_report_${today}.csv`;
    Â  Â  a.click();
    Â  Â  URL.revokeObjectURL(url);
    },
};

// Initialize the application
DashboardApp.init();

</script>
</body>
</html>
